<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Studio Passport - n-dizi.in</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation"></script>

<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Segoe UI',Roboto,sans-serif; background:#f0f2f5; padding:10px}
  .container{max-width:850px; margin:auto; background:#fff; border-radius:20px; box-shadow:0 15px 40px rgba(0,0,0,0.2); overflow:hidden}
  .header{background:#1e3c72; color:#fff; padding:20px; text-align:center}
  .content{padding:20px}
  .upload-area{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px}
  .btn-box{border:2px dashed #1e3c72; border-radius:12px; padding:25px; text-align:center; cursor:pointer; background:#f8fbff}
  input[type=file]{display:none}
  .settings{display:grid; grid-template-columns:repeat(auto-fit, minmax(130px, 1fr)); gap:10px; margin-bottom:20px}
  .card{background:#fff; padding:10px; border:1px solid #ddd; border-radius:10px}
  .card label{display:block; font-size:11px; font-weight:bold; margin-bottom:5px}
  .main-btn{width:100%; padding:16px; border:none; border-radius:30px; font-weight:bold; background:#1e3c72; color:#fff; cursor:pointer; font-size:16px}
  #loading{display:none; text-align:center; margin:15px; color:#1e3c72; font-weight:bold}
  .result{display:none; text-align:center; margin-top:20px}
  canvas{max-width:100%; border-radius:8px; border:1px solid #ccc}
  .footer-btns{margin-top:15px; display:flex; gap:10px; justify-content:center}
  .dl-btn{background:#28a745; color:#fff; padding:12px 25px; border-radius:25px; text-decoration:none; font-weight:bold}
  .modal{display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:100; align-items:center; justify-content:center}
  .modal-inner{background:#fff; padding:15px; border-radius:15px; width:90%; max-width:400px}
  video{width:100%; border-radius:10px; transform:scaleX(-1)}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>‚ú® AI Passport Master Pro</h1>
    <p>300 DPI ‚Ä¢ Smart Retouch ‚Ä¢ Studio Light</p>
  </div>
  
  <div class="content">
    <div class="upload-area">
      <div class="btn-box" onclick="document.getElementById('fileIn').click()">üì§ Upload Photo</div>
      <div class="btn-box" id="openCam">üì∏ Camera</div>
    </div>
    <input type="file" id="fileIn" accept="image/*">

    <div class="settings">
      <div class="card"><label>Quality</label><select disabled><option>High-Res 300 DPI</option></select></div>
      <div class="card"><label>Face Retouch</label>
        <select id="retouch"><option value="0">Off</option><option value="2" selected>Natural Smooth</option><option value="4">High Smooth</option></select>
      </div>
      <div class="card"><label>BG Color</label><input type="color" id="pColor" value="#3b92d1"></div>
      <div class="card"><label>Copies</label><select id="pCopies"><option value="4">4</option><option value="8" selected>8</option></select></div>
    </div>

    <div id="loading">‚ú® Applying AI Retouching & Resolution Tuning...</div>
    <button class="main-btn" id="go" disabled>üöÄ Generate Professional Sheet</button>

    <div class="result" id="res">
      <canvas id="out"></canvas>
      <div class="footer-btns">
        <a href="#" class="dl-btn" id="dl">üì• Download JPG</a>
        <button class="dl-btn" style="background:#007bff" onclick="window.print()">üñ®Ô∏è Print Now</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="m"><div class="modal-inner"><video id="v" autoplay playsinline></video><br>
<button class="dl-btn" id="snap">Snap Photo</button><button class="dl-btn" style="background:red" id="close">Close</button></div></div>

<script>
const fileIn = document.getElementById('fileIn');
const go = document.getElementById('go');
const canvas = document.getElementById('out');
const ctx = canvas.getContext('2d');
const loader = document.getElementById('loading');
let mainImg = new Image();

const ai = new SelfieSegmentation({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`});
ai.setOptions({ modelSelection: 1 });

fileIn.onchange = (e) => {
  const r = new FileReader();
  r.onload = () => { mainImg.src = r.result; mainImg.onload = () => go.disabled = false; };
  r.readAsDataURL(e.target.files[0]);
};

// Camera Section
document.getElementById('openCam').onclick = async () => {
  document.getElementById('v').srcObject = await navigator.mediaDevices.getUserMedia({video: true});
  document.getElementById('m').style.display = 'flex';
};
document.getElementById('close').onclick = () => {
  document.getElementById('v').srcObject.getTracks().forEach(t => t.stop());
  document.getElementById('m').style.display = 'none';
};
document.getElementById('snap').onclick = () => {
  const c = document.createElement('canvas');
  c.width = 1280; c.height = 720;
  c.getContext('2d').drawImage(document.getElementById('v'), 0, 0, 1280, 720);
  mainImg.src = c.toDataURL('image/png');
  document.getElementById('close').click();
};

async function getAIPerson(img) {
  return new Promise(res => {
    ai.onResults(results => {
      const c = document.createElement('canvas');
      c.width = img.width; c.height = img.height;
      const x = c.getContext('2d');
      x.filter = "blur(1.2px)"; // Smooth edges
      x.drawImage(results.segmentationMask, 0, 0);
      x.globalCompositeOperation = 'source-in';
      x.filter = "none";
      x.drawImage(results.image, 0, 0);
      res(c);
    });
    ai.send({image: img});
  });
}

go.onclick = async () => {
  loader.style.display = 'block';
  const person = await getAIPerson(mainImg);
  
  // 300 DPI Pixels
  const pw = 413, ph = 531;
  const bg = document.getElementById('pColor').value;
  const copies = parseInt(document.getElementById('pCopies').value);
  const smoothVal = document.getElementById('retouch').value;

  const single = document.createElement('canvas');
  single.width = pw; single.height = ph;
  const sCtx = single.getContext('2d');

  // Background and Lighting
  sCtx.fillStyle = bg;
  sCtx.fillRect(0, 0, pw, ph);

  // ZOOM & EDGE FIX
  const zoom = 1.32;
  const ar = person.width / person.height;
  let sx, sy, sw, sh;
  if(ar > pw/ph) { sh = person.height/zoom; sw = sh*(pw/ph); sx = (person.width-sw)/2; sy = person.height*0.03; }
  else { sw = person.width/zoom; sh = sw*(ph/pw); sx = (person.width-sw)/2; sy = person.height*0.05; }

  // FACE RETOUCHING & GLOW LOGIC
  sCtx.save();
  // Layer 1: Base Image with Studio Light
  sCtx.filter = "brightness(1.1) contrast(1.05)";
  sCtx.drawImage(person, sx, sy, sw, sh, 0, 0, pw, ph);
  
  // Layer 2: Smoothing Overlay (If enabled)
  if(smoothVal > 0) {
    sCtx.globalAlpha = 0.3; // Blend strength
    sCtx.filter = `blur(${smoothVal}px) brightness(1.05)`; 
    sCtx.drawImage(person, sx, sy, sw, sh, 0, 0, pw, ph);
  }
  sCtx.restore();

  // Grid Builder
  const cols = 4;
  const rows = Math.ceil(copies/cols);
  canvas.width = cols * (pw + 25) + 50;
  canvas.height = rows * (ph + 25) + 50;
  ctx.fillStyle = "#fff";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  for(let i=0; i<copies; i++) {
    const x = 40 + (i%cols)*(pw+25);
    const y = 40 + Math.floor(i/cols)*(ph+25);
    // Black thin border for cutting
    ctx.strokeStyle = "#333";
    ctx.lineWidth = 1;
    ctx.strokeRect(x-1, y-1, pw+2, ph+2);
    ctx.drawImage(single, x, y);
  }

  loader.style.display = 'none';
  document.getElementById('res').style.display = 'block';
  document.getElementById('dl').href = canvas.toDataURL('image/jpeg', 1.0);
  document.getElementById('dl').download = "ai_pro_passport.jpg";
};
</script>
</body>
</html>
