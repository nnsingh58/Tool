<!DOCTYPE html>
<html lang="en">
<head>
    <!-- पिछला CSS कोड वही रहता है -->
    <style>
        /* ... पिछला CSS कोड ... */
        
        .preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <!-- HTML संरचना वही रहती है -->

    <script>
        const canvas = document.getElementById('previewCanvas');
        const ctx = canvas.getContext('2d');
        let uploadedImage = null;
        let isGenerated = false;

        // इमेज अपलोड हैंडलिंग
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.querySelector('.loading').style.display = 'block';
            const reader = new FileReader();
            
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    uploadedImage = img;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('imagePreview').src = event.target.result;
                    document.querySelector('.loading').style.display = 'none';
                    updateCanvas();  // सीधा कैनवास अपडेट
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // कैनवास अपडेट फंक्शन
        function updateCanvas() {
            // कैनवास साइज सेट करें
            const size = document.getElementById('size').value;
            let width = 600, height = 600;
            
            if (size === '2x2') { width = height = 2 * 300; }
            else if (size === '2.5x3.5') { width = 2.5*300; height = 3.5*300; }
            else if (size === '35x45') { width = 35; height = 45; }
            else if (size === '51x51') { width = height = 51; }
            
            canvas.width = width;
            canvas.height = height;

            // बैकग्राउंड भरें
            ctx.fillStyle = document.getElementById('colorPicker').value;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // बॉर्डर ड्रा करें
            if (document.getElementById('borderCheckbox').checked) {
                ctx.strokeStyle = document.getElementById('borderColor').value;
                ctx.lineWidth = document.getElementById('borderThickness').value;
                ctx.strokeRect(0, 0, canvas.width, canvas.height);
            }

            // इमेज ड्रा करें (अगर जेनरेट की गई है)
            if (uploadedImage && isGenerated) {
                const scale = document.getElementById('scale').value / 100;
                const xOffset = document.getElementById('xPosition').value;
                const yOffset = document.getElementById('yPosition').value;
                
                const imgWidth = uploadedImage.width * scale;
                const imgHeight = uploadedImage.height * scale;
                
                const x = (canvas.width - imgWidth) / 2 + xOffset;
                const y = (canvas.height - imgHeight) / 2 + yOffset;

                ctx.drawImage(uploadedImage, x, y, imgWidth, imgHeight);
            }
        }

        // जेनरेट बटन के लिए नया लॉजिक
        function generatePhoto() {
            if (!uploadedImage) {
                alert('कृपया पहले फोटो अपलोड करें');
                return;
            }
            isGenerated = true;
            updateCanvas();
        }

        // इवेंट लिसनर्स को अपडेट करें
        document.getElementById('colorPicker').addEventListener('input', updateCanvas);
        document.getElementById('borderCheckbox').addEventListener('change', function() {
            document.getElementById('borderOptions').style.display = this.checked ? 'block' : 'none';
            updateCanvas();
        });
        
        ['xPosition', 'yPosition', 'scale', 'borderThickness', 'borderColor', 'size'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateCanvas);
        });

        // डाउनलोड फंक्शन
        function downloadPhoto() {
            if (!isGenerated) {
                alert('कृपया पहले फोटो जेनरेट करें');
                return;
            }
            const link = document.createElement('a');
            link.download = `passport-photo-${Date.now()}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
        }

        // इनिशियल सेटअप
        updateCanvas();
    </script>
</body>
</html>
